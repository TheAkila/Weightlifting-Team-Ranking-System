<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weightlifting Rankings - Toggle Total/Sinclair</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media print {
    /* Hide filters and buttons when printing */
    #controls { display: none; }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="max-w-6xl mx-auto p-6">

  <!-- PASSWORD LOGIN -->
  <div id="loginScreen" class="max-w-md mx-auto mt-20 bg-white p-8 rounded shadow text-center">
    <h2 class="text-2xl font-bold mb-4">Please enter password to continue</h2>
    <input
      type="password"
      id="passwordInput"
      class="border p-2 w-full rounded mb-4"
      placeholder="Enter password"
      autocomplete="off"
      />
    <button
      onclick="checkPassword()"
      class="bg-indigo-600 text-white px-4 py-2 rounded w-full hover:bg-indigo-700"
    >
     Login
    </button>
    <p id="passwordMessage" class="mt-3 text-red-600 font-semibold"></p>
  </div>

  <!-- APP CONTENT - initially hidden -->
  <div id="appContent" style="display:none;">

    <header class="flex flex-col md:flex-row items-center justify-between mb-6 bg-white p-4 rounded shadow">
      <img src="assets/uni-logo.png" alt="UoC Logo" class="h-16" />
      <h1 class="text-3xl font-bold text-indigo-900 text-center md:text-left">University of Colombo Weightlifting Rankings</h1>
      <img src="assets/team-logo.png" alt="Team Logo" class="h-16" />
    </header>

    <!-- COUNTDOWN TIMER -->
    <div id="countdownBox" class="bg-yellow-100 text-yellow-900 px-4 py-2 rounded mb-4 text-center font-semibold text-lg">
      Countdown to Festival Meet: <span id="countdownTimer">Loading...</span>
    </div>

    <div id="controls" class="flex flex-wrap gap-4 mb-6 justify-center">
      <select id="genderFilter" class="p-2 border rounded">
        <option value="">All Genders</option>
        <option value="M">Men</option>
        <option value="F">Women</option>
      </select>

      <select id="weightFilter" class="p-2 border rounded">
        <option value="">All Weight Classes</option>
      </select>

      <select id="teamFilter" class="p-2 border rounded">
        <option value="">All Teams</option>
        <option value="Team A">Mens A Team</option>
        <option value="Team B">Mens B Team</option>
        <option value="Past Lifter">Past Lifter</option>
      </select>

      <button id="sortTotalBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">Sort by Total</button>
      <button id="sortSinclairBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded">Sort by Sinclair</button>

      <button id="resetBtn" class="bg-red-200 text-red-800 px-4 py-2 rounded">Reset Filters</button>
      <button onclick="window.print()" class="bg-green-100 text-green-900 px-4 py-2 rounded">Print Rankings</button>
    </div>

    <section>
      <table class="min-w-full bg-white rounded shadow overflow-x-auto text-sm">
        <thead class="bg-indigo-100 text-indigo-900 sticky top-0 z-10">
          <tr>
            <th class="px-3 py-2">Rank</th>
            <th class="px-3 py-2">Name</th>
            <th class="px-3 py-2">Gender</th>
            <th class="px-3 py-2">BW (kg)</th>
            <th class="px-3 py-2">Weight Class</th>
            <th class="px-3 py-2">Snatch</th>
            <th class="px-3 py-2">Clean & Jerk</th>
            <th id="totalHeader" class="px-3 py-2 font-semibold">Total</th>
            <th id="sinclairHeader" class="px-3 py-2 font-semibold hidden">Sinclair</th>
            <th class="px-3 py-2">Team</th>
          </tr>
        </thead>
        <tbody id="rankingTable" class="divide-y divide-gray-200"></tbody>
      </table>
    </section>

  </div>

</div>

<script>
  // PASSWORD LOGIC
  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    const message = document.getElementById("passwordMessage");
    const correctPassword = "uoc2025"; // Change your password here

    if (input === correctPassword) {
      // Hide login and show app
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appContent").style.display = "block";

      // Initialize app only after successful login
      initializeApp();
    } else {
      message.textContent = "Incorrect password, please try again.";
    }
  }

  // APP LOGIC BELOW

  let lifters = [];
  let currentSort = "total"; // default sort

  // Sinclair constants for males and females
  const sinclairConstants = {
    M: { a: 0.794358141, b: 174.393 },
    F: { a: 0.897260740, b: 153.655 },
  };

  // Calculate Sinclair score for one lifter
  function getSinclairScore(bodyweight, total, gender) {
    if (total === 0) return 0;
    const { a, b } = sinclairConstants[gender] || sinclairConstants.M;
    if (bodyweight > b) return 0;
    const coef = Math.pow(10, a * Math.pow(Math.log10(bodyweight / b), 2));
    return +(total * coef).toFixed(2);
  }

  // Render filters options dynamically
  function populateFilters(data) {
    const weightFilter = document.getElementById("weightFilter");
    weightFilter.innerHTML = '<option value="">All Weight Classes</option>';

    const weightClasses = [...new Set(data.map(l => l.weightClass))].sort((a,b) => {
      const numA = parseFloat(a);
      const numB = parseFloat(b);
      if (a.includes('+')) return 1;
      if (b.includes('+')) return -1;
      return numA - numB;
    });

    weightClasses.forEach(w => {
      const option = document.createElement("option");
      option.value = w;
      option.textContent = w;
      weightFilter.appendChild(option);
    });
  }

  function showTotalColumn() {
    document.getElementById("totalHeader").classList.remove("hidden");
    document.getElementById("sinclairHeader").classList.add("hidden");
  }

  function showSinclairColumn() {
    document.getElementById("sinclairHeader").classList.remove("hidden");
    document.getElementById("totalHeader").classList.add("hidden");
  }

  function renderTable() {
    const tbody = document.getElementById("rankingTable");
    tbody.innerHTML = "";

    // Get filters
    const gender = document.getElementById("genderFilter").value;
    const weightClass = document.getElementById("weightFilter").value;
    const team = document.getElementById("teamFilter").value;

    // Filter lifters
    let filtered = lifters.filter(l => 
      (gender ? l.gender === gender : true) &&
      (weightClass ? l.weightClass === weightClass : true) &&
      (team ? l.team === team : true)
    );

    // Add Sinclair scores
    filtered = filtered.map(l => ({
      ...l,
      sinclair: getSinclairScore(l.bodyweight, l.total, l.gender)
    }));

    // Sort by currentSort
    if(currentSort === "total") {
      filtered.sort((a,b) => b.total - a.total);
    } else {
      filtered.sort((a,b) => b.sinclair - a.sinclair);
    }

    // Handle no results
    if(filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-600 italic">No results found.</td></tr>`;
      return;
    }

    // Render rows
    filtered.forEach((l, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2">${i + 1}</td>
        <td class="px-3 py-2">${l.name}</td>
        <td class="px-3 py-2">${l.gender}</td>
        <td class="px-3 py-2">${l.bodyweight.toFixed(1)}</td>
        <td class="px-3 py-2">${l.weightClass}</td>
        <td class="px-3 py-2">${l.snatch}</td>
        <td class="px-3 py-2">${l.cleanJerk}</td>
        <td class="px-3 py-2 font-semibold" style="display: ${currentSort === 'total' ? 'table-cell' : 'none'};">${l.total}</td>
        <td class="px-3 py-2 font-semibold" style="display: ${currentSort === 'sinclair' ? 'table-cell' : 'none'};">${l.sinclair}</td>
        <td class="px-3 py-2">${l.team}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function setupEventListeners() {
    document.getElementById("genderFilter").addEventListener("change", renderTable);
    document.getElementById("weightFilter").addEventListener("change", renderTable);
    document.getElementById("teamFilter").addEventListener("change", renderTable);

    document.getElementById("sortTotalBtn").addEventListener("click", () => {
      currentSort = "total";
      document.getElementById("sortTotalBtn").classList.add("bg-indigo-500", "text-white");
      document.getElementById("sortTotalBtn").classList.remove("bg-gray-300", "text-gray-900");

      document.getElementById("sortSinclairBtn").classList.remove("bg-indigo-500", "text-white");
      document.getElementById("sortSinclairBtn").classList.add("bg-gray-300", "text-gray-900");

      showTotalColumn();
      renderTable();
    });

    document.getElementById("sortSinclairBtn").addEventListener("click", () => {
      currentSort = "sinclair";
      document.getElementById("sortSinclairBtn").classList.add("bg-indigo-500", "text-white");
      document.getElementById("sortSinclairBtn").classList.remove("bg-gray-300", "text-gray-900");

      document.getElementById("sortTotalBtn").classList.remove("bg-indigo-500", "text-white");
      document.getElementById("sortTotalBtn").classList.add("bg-gray-300", "text-gray-900");

      showSinclairColumn();
      renderTable();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("genderFilter").value = "";
      document.getElementById("weightFilter").value = "";
      document.getElementById("teamFilter").value = "";
      currentSort = "total";
      showTotalColumn();

      document.getElementById("sortTotalBtn").classList.add("bg-indigo-500", "text-white");
      document.getElementById("sortTotalBtn").classList.remove("bg-gray-300", "text-gray-900");

      document.getElementById("sortSinclairBtn").classList.remove("bg-indigo-500", "text-white");
      document.getElementById("sortSinclairBtn").classList.add("bg-gray-300", "text-gray-900");

      renderTable();
    });
  }

  // Countdown timer function
  function startCountdown(targetDate) {
    const timerEl = document.getElementById("countdownTimer");

    function updateCountdown() {
      const now = new Date();
      const diff = targetDate - now;

      if (diff <= 0) {
        timerEl.textContent = "Meet is in progress or has ended!";
        // Optionally hide the whole countdown box
        // document.getElementById("countdownBox").style.display = "none";
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      timerEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    updateCountdown(); // call immediately
    setInterval(updateCountdown, 1000); // update every second
  }

  // Initialize app - load data & setup
  async function initializeApp() {
    // Load lifters data from JSON file
    try {
      const res = await fetch("data.json");
      lifters = await res.json();
    } catch (e) {
      alert("Failed to load lifters data.");
      return;
    }

    populateFilters(lifters);
    setupEventListeners();
    showTotalColumn();
    renderTable();

    // Start countdown timer to your meet
    startCountdown(new Date("2025-07-15T09:00:00"));
  }
</script>

</body>
</html>
